const suggestions=["VTuber","Streamer AFK","Over 10,000 viewers","Pet cam","IRL stream","Hottub stream","Movie/TV show","Streamer you recognize","Console stream","Speedrunner","Empty chat","Gambling","Sleeping","Dancing","#AD stream","Sponsors overlay","Reacting to videos","Low quality cam","Low quality mic","Cam bigger than gameplay","NotLikeThis screen","ASMR stream","1k+ viewers & inactive chat","Hand cam","Cosplaying","Random gifs in overlay","Driving stream","Esports tournament","Playing an instrument","Subscribers only chat","Room full of RGB lights","Follow goal overlay","Sub count overlay","Default profile picture","Eating","Same game 2 times in a row","Top gifter 100+ gifts","Top cheerer 10k+ bits","Only mods & VIPs in chat","Game older than 20 years","24/7 music stream","Kid streaming","Activate Windows watermark","Singing","Polish streamer 🇵🇱","Cooking","Only bots in chat","Hype Train active","Wrong stream category","Neon username sign","Subathon","Always on animals stream","Affiliate/Partner anniversary","Birthday stream","Numbers in username","Art stream","Social links overlay","Streamer you follow","Fullscreen facecam","Chat overlay","Emotes overlay","Pinned chat message","Drops enabled","Mobile stream","Programming stream","Streamer doesn't speak for 1m","Donation goal overlay","Stream ending","Wearing their own merch","TTS","Emoji in title"],elements={leaderboardCount:document.getElementById("leaderboardCount"),leaderboard:document.getElementById("leaderboard"),infoTime:document.getElementById("infoTime"),skipSexual:document.getElementById("skipSexual"),unloadWarningBingo:document.getElementById("unloadWarningBingo"),seenChannels:document.getElementById("seenChannels"),resetSeenChannels:document.getElementById("resetSeenChannels"),loginExpiredModal:document.getElementById("loginExpiredModal"),allowDiagonals:document.getElementById("allowDiagonals"),twitchBingo:document.getElementById("twitchBingo"),customBingo:document.getElementById("customBingo"),bingoTypeDescription:document.getElementById("bingoTypeDescription"),customBingoName:document.getElementById("customBingoName"),bingoSize:document.getElementById("bingoSize"),bingoSizeLabel:document.getElementById("bingoSizeLabel"),boardInputs:document.getElementById("boardInputs"),board:document.getElementById("board"),boardSearch:document.getElementById("board-search"),boardSearchBar:document.getElementById("board-search-bar"),boardSearchToggle:document.getElementById("board-search-toggle"),boardContent:document.getElementById("board-inner"),previewDiv:document.getElementById("previewDiv"),previewBoard:document.getElementById("previewBoard"),previewUsername:document.getElementById("previewUsername"),toastContainer:document.getElementById("toastContainer"),settingsCard:document.getElementById("settingsCard"),start:document.getElementById("start"),mainCard:document.getElementById("mainCard"),twitchEmbedDiv:document.getElementById("twitchEmbedDiv"),twitchEmbed:document.getElementById("twitchEmbed"),boardSize:document.getElementById("boardSize"),boardOpacity:document.getElementById("boardOpacity"),loginButton:document.getElementById("loginButton"),loginInfo:document.getElementById("loginInfo"),loginDescription:document.getElementById("loginDescription"),loginInfoPFP:document.getElementById("loginInfoPFP"),bingoLink:document.getElementById("bingoLink"),copyButton:document.getElementById("copyButton"),previousStream:document.getElementById("previousStream"),bingoPopover:document.getElementById("bingoPopover"),nextStream:document.getElementById("nextStream")};let loginExpiredModal,copyButton,player,refreshCooldown,channelName,bingoPopover,TWITCH={channel:"",access_token:"",userID:""},mainList=[],seenChannels=[],previousChannels=[],retryLimit=0,customBadges=[],skipSexual=!0,unloadWarningBingo=!0,userInteracted=!1,bingoType="twitch",bingoSize=5,board=[],won=!1,boardCreated=!1;async function getMainList(){try{let e=await fetch(`https://api.okayeg.com/guess?dank=${Date.now()}`,requestOptions),t=await e.json();mainList=t.guess.guess,elements.infoTime.innerHTML=`Channel list updated on ${new Date(t.guess.time)}`}catch(e){console.log(e),showToast("Could not load channel list :(","danger","5000")}}async function nextStream(){let e=player?.getChannel()||0,t=previousChannels.findIndex((t=>t==e));if(previousChannels[t+1])return void showPreviousStream(t,!0);elements.nextStream.disabled=!0,setTimeout((()=>{elements.nextStream.disabled=!1}),2e3),previousChannels.length>0&&(elements.previousStream.disabled=!1);let n=mainList.pop();for(;seenChannels.includes(n.username)||n.sexual&&skipSexual;)n=mainList.pop();if(0==mainList.length||!n)return showToast("No more channels left on the list ...getting new list","danger","3000"),await getMainList(),shuffleArray(mainList),void nextStream();if(retryLimit>5)return showToast("Too many retries, something might be wrong :( ...attempting to fix","danger","3000"),await getMainList(),shuffleArray(mainList),void nextStream();try{let e=await fetch(`https://helper.guessr.tv/twitch/streams?user_id=${n.userid}`,requestOptions);if(!(await e.json()).data[0])return showToast("Channel is offline, getting new channel","info",1500),retryLimit++,nextStream();retryLimit=0;let t={width:"100%",height:"100%",channel:n.username,layout:"video-with-chat",theme:"dark",parent:["guessr.tv","127.0.0.1"]};player?player.setChannel(n.username):player=new Twitch.Embed("twitchEmbed",t),previousChannels.push(n.username),seenChannels.push(n.username),localStorage.setItem("seenChannels_bingo",JSON.stringify(seenChannels)),elements.seenChannels.innerHTML=seenChannels.length.toLocaleString(),n.username==channelName&&(showConfetti(2),sendUsername(" - dank ⚠️ ⚠️ ⚠️"))}catch(e){return console.log(e),retryLimit++,nextStream()}}function previousStream(){let e=player.getChannel(),t=previousChannels.findIndex((t=>t==e));0!=t?showPreviousStream(t,!1):showToast("Can't go further back","danger","3000")}function showPreviousStream(e,t){player.setChannel(previousChannels[e+=t?1:-1])}function dragElement(){let e=0,t=0;const n=function(n){elements.board.style.top=elements.board.offsetTop+n.clientY-t+"px",elements.board.style.left=elements.board.offsetLeft+n.clientX-e+"px",e=n.clientX,t=n.clientY},o=function(){document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",o)};elements.board.addEventListener("mousedown",(function(a){a.target.classList.contains("bingo-cell")&&1!==a.button||(e=a.clientX,t=a.clientY,document.addEventListener("mousemove",n),document.addEventListener("mouseup",o))}))}function fillCell(e){if(!boardCreated)return;clearTimeout(refreshCooldown),e.target.classList.toggle("filled"),hideSearchBar();let t=parseInt(e.target.dataset.id,10)-1;board[t].filled=!board[t].filled,checkWin(board,!0),TWITCH?.channel&&(refreshCooldown=setTimeout((()=>{updateLeaderboard()}),3e3))}function randomize(e){const t=e.target.dataset.itemId,n=document.querySelector(`[data-item-id="${t}"]`),o=[...document.querySelectorAll(".bingo-item")].map((e=>e.value)).filter(Boolean);let a=suggestions[Math.floor(Math.random()*suggestions.length)];if(o.length>=suggestions.length)showToast("No more presets left","danger",3e3);else{for(;o.includes(a);)a=suggestions[Math.floor(Math.random()*suggestions.length)];n.value=a,loadItems(),userInteracted=!0,changeSiteLinkTarget("_blank")}}function randomizeAll(){const e=document.querySelectorAll(".bingo-item");let t=shuffleArray(structuredClone(suggestions));for(let n=0;n<e.length;n++){let o=t.pop();if(!o){showToast("No more presets left","danger",3e3);break}e[n].value=o}loadItems(),userInteracted=!0,changeSiteLinkTarget("_blank")}function clearAll(){const e=document.querySelectorAll(".bingo-item"),t=document.querySelectorAll(".bingo-cell");for(let n=0;n<e.length;n++)e[n].value="",t[n].innerText=n+1,t[n].classList.remove("duplicate");userInteracted=!1,changeSiteLinkTarget("_self")}async function start(){elements.start.innerHTML=spinner,await uploadBoard(),boardCreated?("twitch"==bingoType&&(await getMainList(),shuffleArray(mainList),nextStream(),elements.twitchEmbedDiv.style.display=""),elements.settingsCard.style.display="none",elements.board.style.display="",elements.mainCard.style.display="",userInteracted=!0,changeSiteLinkTarget("_blank")):elements.start.innerHTML='<i class="material-icons notranslate">celebration</i> Start!'}function loadItems(){const e=document.querySelectorAll(".bingo-item"),t=document.querySelectorAll(".bingo-cell"),n=[...e].map((e=>e.value.trim()));for(let e=0;e<t.length;e++)t[e].innerText=n[e]||e+1,t[e].title=n[e],t[e].classList.remove("filled"),t[e].classList.remove("selected"),board[e].value=n[e],board[e].filled=!1;checkDuplicatesOnBoard()}function updateSingleItem(e){const t=parseInt(e.dataset.itemId,10),n=t-1,o=document.querySelector(`.bingo-cell[data-id="${t}"]`),a=e.value.trim();board[n].value=a.trim(),board[n].filled=!1,o.innerText=a.trim(),o.title=a.trim(),o.classList.remove("filled"),checkDuplicatesOnBoard()}function activateCellById(e){const t=e.dataset.itemId;document.querySelector(`.bingo-cell[data-id="${t}"]`).classList.add("selected")}function deactivateCellById(e){const t=e.dataset.itemId;document.querySelector(`.bingo-cell[data-id="${t}"]`).classList.remove("selected")}function checkDuplicatesOnBoard(){const e=board.map((e=>e.value.toLowerCase())),t=new Set(e.filter((t=>e.indexOf(t)!==e.lastIndexOf(t))));if(t.size>0){const e=document.querySelectorAll(".bingo-cell");for(let n=0;n<board.length;n++){const o=board[n].value.toLowerCase();e[n].classList.toggle("duplicate",o&&t.has(o))}}else document.querySelectorAll(".bingo-cell").forEach((e=>e.classList.remove("duplicate")))}function doBoardSearch(){const e=(elements.boardSearchBar.value||"").trim().toLowerCase(),t=document.querySelectorAll(".bingo-cell");if(e)for(let n=0;n<board.length;n++){const o=board[n].value&&board[n].value.toLowerCase().includes(e);t[n].classList.toggle("matching",o)}else document.querySelectorAll(".bingo-cell").forEach((e=>e.classList.remove("matching")));elements.boardSearchBar.value?elements.boardSearchToggle.querySelector("i").innerText="clear":(elements.boardSearchToggle.querySelector("i").innerText="search",elements.boardSearchBar.classList.remove("expanded"))}function toggleSearchBar(){elements.boardSearchBar.value="","search"==elements.boardSearchToggle.querySelector("i").innerText?(elements.boardSearchToggle.querySelector("i").innerText="clear",elements.boardSearchBar.classList.add("expanded"),elements.boardSearchBar.focus(),elements.boardSearchBar.select()):hideSearchBar()}function hideSearchBar(){elements.boardSearchToggle.querySelector("i").innerText="search",elements.boardSearchBar.classList.remove("expanded"),document.querySelectorAll(".bingo-cell").forEach((e=>e.classList.remove("matching")))}async function uploadBoard(){let e=[];const t=document.querySelectorAll(".bingo-item"),n=document.querySelectorAll(".bingo-cell");if(e=TWITCH?.userID?shuffleArraySeed([...t].map((e=>e.value.trim())),TWITCH.userID):shuffleArray([...t].map((e=>e.value.trim()))),e.includes(""))return void showToast("Board must be full","warning",2e3);const o=board.map((e=>e.value.toLowerCase()));if(new Set(o.filter((e=>o.indexOf(e)!==o.lastIndexOf(e)))).size>0)showToast("Board must not have duplicates","warning",2e3);else{document.querySelectorAll(".bingo-cell").forEach((e=>{e.classList.remove("duplicate"),e.classList.remove("selected")}));for(let t=0;t<n.length;t++)n[t].innerText=e[t],n[t].title=e[t],n[t].classList.remove("filled"),board[t].value=e[t],board[t].filled=!1;if(TWITCH?.access_token){let e={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({userid:TWITCH.userID,username:TWITCH.channel,access_token:TWITCH.access_token,time:new Date,board:board,title:"twitch"==bingoType?"Twitch Bingo":elements.customBingoName.value||"Custom Bingo",allowDiagonals:elements.allowDiagonals.checked}),redirect:"follow"};try{let t=await fetch("https://bingo.guessr.tv/save",e),n=await t.json();200==t.status&&(boardCreated=!0),showToast(n.message,"info",3e3)}catch(e){showToast("Could not upload board","danger",3e3),console.log("save error",e)}}else boardCreated=!0}}function checkWin(e,t=!1){let n=[],o=[],a=[[],[]],l=Math.sqrt(e.length);for(let t=0;t<l;t++){let o=[];for(let n=0;n<l;n++)o.push(e[n+t*l]);n.push(o)}for(let e=0;e<n.length;e++){let t=[];for(let o=0;o<n[e].length;o++)t.push(n[o][e]);o.push(t)}for(let e=0;e<l;e++)a[0].push(n[e][e]);for(let e=0;e<l;e++)a[1].push(n[e][l-e-1]);let s={bingos:0,score:0},i={0:0,1:0,2:1,3:10,4:50,5:100,6:200,7:300,8:400,9:500,10:1e3};for(let e=0;e<l;e++){let t=n[e],a=o[e],l=t.reduce(((e,t)=>e+t.filled),0),r=a.reduce(((e,t)=>e+t.filled),0);s.score+=i[l],s.score+=i[r],t.every((e=>e.filled))&&s.bingos++,a.every((e=>e.filled))&&s.bingos++}if(elements.allowDiagonals.checked){let e=a[0].reduce(((e,t)=>e+t.filled),0),t=a[1].reduce(((e,t)=>e+t.filled),0);s.score+=i[e],s.score+=i[t],a[0].every((e=>e.filled))&&s.bingos++,a[1].every((e=>e.filled))&&s.bingos++}return s.score+=1e3*s.bingos,t&&s.bingos>0&&!won&&(showConfetti(2),won=!0),t&&0==s.bingos&&(won=!1),s}function login(){return elements.loginInfoPFP.src="/pics/donk.png",elements.bingoLink.value="Loading...",elements.loginButton.innerHTML=spinner,window.open("/prompt.html","loginWindow","toolbar=0,status=0,scrollbars=0,width=500px,height=800px"),!1}function resetLoginButton(){elements.loginButton.innerHTML='<span class="twitch-icon"></span> Sign in with Twitch',elements.loginDescription.style.display=""}function logout(){TWITCH={channel:"",access_token:"",userID:""},localStorage.setItem("TWITCH",JSON.stringify(TWITCH)),elements.loginButton.disabled=!1,elements.loginButton.innerHTML='<span class="twitch-icon"></span> Sign in with Twitch',elements.loginDescription.style.display="",elements.loginInfo.style.display="none",elements.loginInfoPFP.src="/pics/donk.png",elements.bingoLink.value="https://bingo.guessr.tv"}async function loadPFP(){let e=await get7TVPFP(TWITCH.userID);"/pics/donk.png"==e&&TWITCH.access_token&&(e=await getTwitchPFP(TWITCH.channel,TWITCH.access_token)),elements.loginInfoPFP.src=e}function loadInfo(){TWITCH=JSON.parse(localStorage.getItem("TWITCH")),elements.loginButton.disabled=!0,elements.loginButton.innerHTML=`<span class="twitch-icon"></span><i class="material-icons notranslate">done</i>Logged in as <strong>${TWITCH.channel}</strong>`,elements.loginInfo.style.display="",elements.loginDescription.style.display="none",elements.bingoLink.value=`https://bingo.guessr.tv/${TWITCH.channel}`,loadPFP()}function copyLink(){elements.bingoLink.select(),elements.bingoLink.setSelectionRange(0,99999),navigator.clipboard.writeText(elements.bingoLink.value),copyButton.show(),setTimeout((()=>{copyButton.hide()}),1e3)}let chatWinner=!1;async function updateLeaderboard(){elements.leaderboard.innerHTML=spinner,elements.leaderboardCount.innerHTML="Loading...";let e={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({userid:TWITCH.userID,username:TWITCH.channel,access_token:TWITCH.access_token,time:new Date,board:board,allowDiagonals:elements.allowDiagonals.checked}),redirect:"follow"};try{let t=await fetch("https://bingo.guessr.tv/update",e),n=await t.json();console.log(n);let o=n.users;for(let e=0;e<o.length;e++)o[e].userid==TWITCH.userID?o[e].board=structuredClone(board):o[e].board=shuffleArraySeed(structuredClone(board),o[e].userid),o[e].result=checkWin(o[e].board);o.sort(((e,t)=>e.result.score-t.result.score)),elements.leaderboardCount.innerHTML=o.length,elements.leaderboard.innerHTML="";for(let e=0;e<o.length;e++)!chatWinner&&o[e].result.bingos>0&&(chatWinner=!0,bingoPopover.show(),setTimeout((()=>{bingoPopover.hide()}),3e3)),elements.leaderboard.insertAdjacentHTML("afterbegin",`<li class="list-group-item ${o[e].userid==TWITCH.userID?"active":""}">\n        ${addBadges(o[e].userid==TWITCH.userID?"streamer":[],o[e].userid)} ${o[e].username}: ${o[e].result.score.toLocaleString()} ${1==o[e].result.score?"point":"points"} ${o[e].result.bingos>0?`(${o[e].result.bingos} ${1==o[e].result.bingos?"BINGO":"BINGOs"})`:""}\n        <i class="material-icons notranslate float-end cursor-pointer" \n        onmouseout="hidePreview()" onmouseover="showPreview('${o[e].username}','${o[e].userid}',${o[e].result.score},${o[e].result.bingos})">\n        preview\n        </i>\n        </li>`)}catch(e){showToast("Could not refresh leaderboard","danger",3e3),console.log("updateLeaderboard error",e)}}function showPreview(e,t,n,o){elements.previewUsername.innerHTML=`\n  ${encodeHTML(e)}'s bingo board<br>Score: ${n.toLocaleString()} ${1==n?"point":"points"} ${o>0?`(${o} ${1==o?"BINGO":"BINGOs"})`:""}`;let a=[];a=t==TWITCH.userID?structuredClone(board):shuffleArraySeed(structuredClone(board),t);const l=document.querySelectorAll(".bingo-cell-preview");for(let e=0;e<board.length;e++)l[e].classList.remove("filled");for(let e=0;e<l.length;e++)l[e].innerText=a[e].value,l[e].title=a[e].value,a[e].filled&&l[e].classList.add("filled");elements.previewDiv.style.display=""}function hidePreview(){elements.previewDiv.style.display="none"}function loadInputs(){elements.boardInputs.innerHTML="",board=[];let e=bingoSize*bingoSize||25;for(let t=0;t<e;t++)board.push({filled:!1,value:""}),elements.boardInputs.insertAdjacentHTML("beforeend",`<div class="input-group mb-1 w-50 pe-1">\n        <input type="text" class="form-control bingo-item"\n        onfocus="activateCellById(this)" onblur="deactivateCellById(this)" oninput="updateSingleItem(this)" \n        placeholder="Bingo item #${t+1}" data-item-id="${t+1}" aria-label="Bingo item #${t+1}" />\n        <button class="btn btn-outline-secondary" onclick="randomize(event)" data-item-id="${t+1}" type="button" title="Fill with random item">\n          <i class="material-icons notranslate pointer-events-none">casino</i>\n        </button>\n      </div>`)}function loadBoard(){elements.boardContent.innerHTML="",elements.previewBoard.innerHTML="",elements.board.style.top="6%",elements.board.style.left="6%",elements.board.style.scale=1;let e=bingoSize||5,t=0;for(let n=0;n<e;n++){let o="",a="";for(let l=0;l<e;l++){t++;let s="";0==n&&0==l&&(s='style="border-top-left-radius: 6px"'),0==n&&l==e-1&&(s='style="border-top-right-radius: 6px"'),n==e-1&&0==l&&(s='style="border-bottom-left-radius: 6px"'),n==e-1&&l==e-1&&(s='style="border-bottom-right-radius: 6px"'),1==e&&(s='style="border-radius: 6px"'),o+=`\n      <div onclick="fillCell(event)" data-id="${t}" class="col bingo-cell" ${s}>\n      ${t}\n      </div>`,a+=`\n      <div data-id="${t}" class="col bingo-cell-preview" ${s}>\n      ${t}\n      </div>`}elements.boardContent.insertAdjacentHTML("beforeend",`<div class="row m-0">\n      ${o}\n      </div>`),elements.previewBoard.insertAdjacentHTML("beforeend",`<div class="row m-0">\n      ${a}\n      </div>`)}}window.onload=async function(){seenChannels=JSON.parse(localStorage.getItem("seenChannels_bingo"))||[],elements.seenChannels.innerHTML=seenChannels.length.toLocaleString(),skipSexual="true"===(localStorage.getItem("skipSexual")||"true"),elements.skipSexual.checked=skipSexual,unloadWarningBingo="true"===(localStorage.getItem("unloadWarningBingo")||"true"),elements.unloadWarningBingo.checked=unloadWarningBingo,elements.resetSeenChannels.onclick=function(){localStorage.setItem("seenChannels_bingo",JSON.stringify([])),elements.seenChannels.innerHTML=0,seenChannels=[],showToast("Seen channels reset","success",2e3)},loginExpiredModal=new bootstrap.Modal(elements.loginExpiredModal),copyButton=new bootstrap.Popover(elements.copyButton),bingoPopover=new bootstrap.Popover(elements.bingoPopover),TWITCH=JSON.parse(localStorage.getItem("TWITCH")),TWITCH?.access_token&&!await checkToken(TWITCH.access_token)&&(TWITCH.channel="",TWITCH.access_token="",loginExpiredModal.show()),TWITCH?.channel&&(channelName=TWITCH.channel,loadInfo(),sendUsername("/bingo")),elements.twitchBingo.onchange=function(){this.checked&&(bingoType="twitch",elements.bingoTypeDescription.innerHTML="Random Twitch streams will be shown",elements.customBingoName.style.display="none")},elements.customBingo.onchange=function(){this.checked&&(bingoType="custom",elements.bingoTypeDescription.innerHTML="A custom bingo board that can be used to play with your viewers",elements.customBingoName.style.display="")},elements.bingoSize.oninput=function(){bingoSize=parseInt(this.value,10),elements.bingoSizeLabel.innerHTML=`Board size: ${bingoSize}x${bingoSize} (${bingoSize*bingoSize} ${1==bingoSize?"item":"items"})`,elements.boardSearch.style.display=bingoSize<3?"none":"",loadInputs(),loadBoard()},elements.skipSexual.onchange=function(){skipSexual=this.checked,localStorage.setItem("skipSexual",skipSexual)},elements.unloadWarningBingo.onchange=function(){unloadWarningBingo=this.checked,localStorage.setItem("unloadWarningBingo",unloadWarningBingo)},elements.boardSize.oninput=function(){elements.board.style.scale=this.value},elements.boardOpacity.oninput=function(){elements.board.style.opacity=this.value},elements.board.addEventListener("mousewheel",(e=>{if(e.preventDefault(),e.stopPropagation(),e.ctrlKey){let t=parseFloat(getComputedStyle(elements.board).getPropertyValue("opacity"));elements.board.style.opacity=e.wheelDelta>0?Math.min(t+.07,1):Math.max(t-.07,0),elements.boardOpacity.value=e.wheelDelta>0?t+.07:t-.07}else{let t=parseFloat(getComputedStyle(elements.board).getPropertyValue("scale"));elements.board.style.scale=e.wheelDelta>0?Math.min(t+.07,2):Math.max(t-.07,.1),elements.boardSize.value=e.wheelDelta>0?t+.07:t-.07}})),dragElement(),enableTooltips(),loadInputs(),loadBoard(),customBadges=await getCustomBadges()},window.onbeforeunload=function(){return unloadWarningBingo&&userInteracted?"Unload warning enabled. You can turn it off in the settings.":null};