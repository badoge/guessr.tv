const suggestions=["VTuber","Streamer AFK","Over 10,000 viewers","Pet cam","IRL stream","Hottub stream","Watching a movie/TV show","Streamer you follow","Console stream","Speedrunning","Empty chat","Playing Slots","Sleeping during a subathon","Korean dancer","#AD stream","Reacting to videos","Low quality cam","Cam bigger than gameplay","NotLikeThis screen","ASMR stream","1k+ viewers with an inactive chat","Hand cam","Cosplaying","Random gifs in overlay","Driving stream","Esports tournament","Playing an instrument","Subscribers only chat","Room full of RGB lights"],elements={leaderboardCount:document.getElementById("leaderboardCount"),leaderboard:document.getElementById("leaderboard"),infoTime:document.getElementById("infoTime"),seenChannels:document.getElementById("seenChannels"),resetSeenChannels:document.getElementById("resetSeenChannels"),loginExpiredModal:document.getElementById("loginExpiredModal"),editModal:document.getElementById("editModal"),allowDiagonals:document.getElementById("allowDiagonals"),bingoItems:document.querySelectorAll(".bingo-item"),randomize:document.querySelectorAll(".bingo-random"),bingoSave:document.getElementById("bingoSave"),board:document.getElementById("board"),previewBoard:document.getElementById("previewBoard"),previewUsername:document.getElementById("previewUsername"),cells:document.querySelectorAll(".bingo-cell"),previewCells:document.querySelectorAll(".bingo-cell-preview"),toastContainer:document.getElementById("toastContainer"),welcomeCard:document.getElementById("welcomeCard"),start:document.getElementById("start"),twitchEmbed:document.getElementById("twitchEmbed"),boardSize:document.getElementById("boardSize"),boardOpacity:document.getElementById("boardOpacity"),loginButton:document.getElementById("loginButton"),loginInfo:document.getElementById("loginInfo"),loginInfoPFP:document.getElementById("loginInfoPFP"),bingoLink:document.getElementById("bingoLink"),copyButton:document.getElementById("copyButton"),previousStream:document.getElementById("previousStream"),nextStream:document.getElementById("nextStream")};let loginExpiredModal,editModal,copyButton,player,refreshCooldown,TWITCH={channel:"",access_token:"",userID:""},mainList=[],seenChannels=[],previousChannels=[],retryLimit=0,customBadges=[],board=[{filled:!1,value:"1"},{filled:!1,value:"2"},{filled:!1,value:"3"},{filled:!1,value:"4"},{filled:!1,value:"5"},{filled:!1,value:"6"},{filled:!1,value:"7"},{filled:!1,value:"8"},{filled:!1,value:"9"},{filled:!1,value:"10"},{filled:!1,value:"11"},{filled:!1,value:"12"},{filled:!1,value:"13"},{filled:!1,value:"14"},{filled:!1,value:"15"},{filled:!1,value:"16"},{filled:!1,value:"17"},{filled:!1,value:"18"},{filled:!1,value:"19"},{filled:!1,value:"20"},{filled:!1,value:"21"},{filled:!1,value:"22"},{filled:!1,value:"23"},{filled:!1,value:"24"},{filled:!1,value:"25"}],won=!1,boardCreated=!1;async function getMainList(){try{let e=await fetch("https://api.okayeg.com/guess",requestOptions),n=await e.json();mainList=n.guess.guess,elements.infoTime.innerHTML=`Channel list updated on ${new Date(n.guess.time)}`}catch(e){console.log(e),showToast("Could not load channel list :(","danger","5000")}}async function nextStream(){let e=player?.getChannel()||0,n=previousChannels.findIndex((n=>n==e));if(previousChannels[n+1])return void showPreviousStream(n,!0);elements.nextStream.disabled=!0,setTimeout((()=>{elements.nextStream.disabled=!1}),2e3),previousChannels.length>0&&(elements.previousStream.disabled=!1);let t=mainList.pop();for(;seenChannels.includes(t.username);)t=mainList.pop();if(0!=mainList.length&&t)if(retryLimit>5)showToast("Too many retries, something might be wrong :(","danger","3000");else try{let e=await fetch(`https://helper.pepega.workers.dev/twitch/streams?user_id=${t.userid}`,requestOptions);if(!(await e.json()).data[0])return showToast("Channel is offline, getting new channel","info",1500),retryLimit++,nextStream();retryLimit=0;let n={width:"100%",height:"100%",channel:t.username,layout:"video-with-chat",theme:"dark",parent:["guessr.tv","127.0.0.1"]};player?player.setChannel(t.username):player=new Twitch.Embed("twitchEmbed",n),previousChannels.push(t.username),seenChannels.push(t.username),localStorage.setItem("seenChannels_bingo",JSON.stringify(seenChannels)),elements.seenChannels.innerHTML=seenChannels.length}catch(e){return console.log(e),retryLimit++,nextStream()}else showToast("No more channels left on the list, refresh to get a new list","danger","3000")}function previousStream(){let e=player.getChannel(),n=previousChannels.findIndex((n=>n==e));0!=n?showPreviousStream(n,!1):showToast("Can't go further back","danger","3000")}function showPreviousStream(e,n){player.setChannel(previousChannels[e+=n?1:-1])}function dragElement(){let e=0,n=0;const t=function(t){elements.board.style.top=elements.board.offsetTop+t.clientY-n+"px",elements.board.style.left=elements.board.offsetLeft+t.clientX-e+"px",e=t.clientX,n=t.clientY},l=function(){document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",l)};elements.board.addEventListener("mousedown",(function(o){o.target.classList.contains("bingo-cell")&&1!==o.button||(e=o.clientX,n=o.clientY,document.addEventListener("mousemove",t),document.addEventListener("mouseup",l))}))}function randomize(e){const n=e.target.dataset.itemId,t=document.querySelector(`[data-item-id="${n}"]`),l=[...elements.bingoItems].map((e=>e.value));let o=suggestions[Math.floor(Math.random()*suggestions.length)];for(;l.includes(o);)o=suggestions[Math.floor(Math.random()*suggestions.length)];t.value=o}function randomizeAll(){let e=shuffleArray(structuredClone(suggestions));for(let n=0;n<elements.bingoItems.length;n++)elements.bingoItems[n].value=e.pop()}function clearAll(){for(let e=0;e<elements.bingoItems.length;e++)elements.bingoItems[e].value=""}async function start(){if(!boardCreated)return showToast("You need to create and save your board first","warning",3e3),void editModal.show();elements.start.innerHTML=spinner,await getMainList(),shuffleArray(mainList),nextStream(),elements.welcomeCard.style.display="none",elements.twitchEmbed.style.display="",elements.board.style.display=""}async function bingoSave(){elements.bingoSave.innerHTML=spinner;let e=[];if(e=TWITCH?.userID?shuffleArraySeed([...elements.bingoItems].map((e=>e.value.trim())),TWITCH.userID):shuffleArray([...elements.bingoItems].map((e=>e.value.trim()))),e.includes(""))return showToast("Board must be full","warning",2e3),void(elements.bingoSave.innerHTML='<i class="material-icons notranslate">save</i> Save');if(hasDuplicates(e))return showToast("Board must not have duplicates","warning",2e3),void(elements.bingoSave.innerHTML='<i class="material-icons notranslate">save</i> Save');for(let n=0;n<elements.cells.length;n++)elements.cells[n].innerText=e[n],elements.cells[n].title=e[n],elements.cells[n].classList.remove("filled"),board[n].value=e[n],board[n].filled=!1;if(won=!1,TWITCH?.access_token){let e={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({userid:TWITCH.userID,username:TWITCH.channel,access_token:TWITCH.access_token,time:new Date,board:[...elements.bingoItems].map((e=>e.value.trim())),allowDiagonals:elements.allowDiagonals.checked}),redirect:"follow"};try{let n=await fetch("https://bingo.guessr.tv/save",e),t=await n.json();showToast(t.message,"info",3e3)}catch(e){showToast("Could not upload board","danger",3e3),console.log("save error",e)}}boardCreated=!0,editModal.hide(),elements.bingoSave.innerHTML='<i class="material-icons notranslate">save</i> Save'}function checkWin(){let e=[[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24]];elements.allowDiagonals.checked&&e.push([0,6,12,18,24],[4,8,12,16,20]);let n=0;for(let t=0;t<e.length;t++)board[e[t][0]].filled&&board[e[t][1]].filled&&board[e[t][2]].filled&&board[e[t][3]].filled&&board[e[t][4]].filled&&n++;1!=n||won||(showConfetti(2),won=!0),0==n&&(won=!1)}function checkWinLeaderboard(e){let n=[[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24]];elements.allowDiagonals.checked&&n.push([0,6,12,18,24],[4,8,12,16,20]);let t=0;for(let l=0;l<n.length;l++)e[n[l][0]].filled&&e[n[l][1]].filled&&e[n[l][2]].filled&&e[n[l][3]].filled&&e[n[l][4]].filled&&t++;return t}function login(){return elements.loginInfoPFP.src="/pics/donk.png",elements.bingoLink.value="Loading...",elements.loginButton.innerHTML=spinner,window.open("/prompt.html","loginWindow","toolbar=0,status=0,scrollbars=0,width=500px,height=800px"),!1}function resetLoginButton(){elements.loginButton.innerHTML='<span class="twitch-icon"></span> Sign in with Twitch'}function logout(){TWITCH={channel:"",access_token:"",userID:""},localStorage.setItem("TWITCH",JSON.stringify(TWITCH)),elements.loginButton.style.display="",elements.loginInfo.style.display="none",elements.loginInfoPFP.src="/pics/donk.png",elements.bingoLink.value="https://bingo.guessr.tv"}async function loadPFP(){let e=await get7TVPFP(TWITCH.userID);"/pics/donk.png"==e&&TWITCH.access_token&&(e=await getTwitchPFP(TWITCH.channel,TWITCH.access_token)),elements.loginInfoPFP.src=e}function loadInfo(){TWITCH=JSON.parse(localStorage.getItem("TWITCH")),elements.loginButton.style.display="none",elements.loginInfo.style.display="",elements.bingoLink.value=`https://bingo.guessr.tv/${TWITCH.channel}`,loadPFP()}function copyLink(){elements.bingoLink.select(),elements.bingoLink.setSelectionRange(0,99999),navigator.clipboard.writeText(elements.bingoLink.value),copyButton.show(),setTimeout((()=>{copyButton.hide()}),1e3)}async function refreshLeaderboard(){elements.leaderboard.innerHTML="",elements.leaderboardCount.innerHTML="";try{let e=await fetch(`https://bingo.guessr.tv/${TWITCH.channel}/list`,requestOptions),n=await e.json(),t=[...elements.bingoItems].map((e=>e.value.trim()));for(let e=0;e<n.length;e++){n[e].board=shuffleArraySeed(structuredClone(t),n[e].userid).map((e=>({value:e,filled:!1})));for(let t=0;t<board.length;t++){const l=n[e].board.findIndex((e=>e.value==board[t].value));n[e].board[l].filled=board[t].filled}n[e].lines=checkWinLeaderboard(n[e].board)}n.sort(((e,n)=>e.lines-n.lines)),elements.leaderboardCount.innerHTML=n.length;for(let e=0;e<n.length;e++)elements.leaderboard.insertAdjacentHTML("afterbegin",`<li class="list-group-item">\n        ${addBadges([],n[e].userid)} ${n[e].username}: ${n[e].lines} \n        <i class="material-icons notranslate float-end cursor-pointer" onmouseout="hidePreview()" onmouseover="showPreview('${n[e].username}','${n[e].userid}')">preview</i>\n        </li>`)}catch(e){showToast("Could not refresh leaderboard","danger",3e3),console.log("refreshLeaderboard error",e)}}function showPreview(e,n){elements.previewUsername.innerText=`${e}'s bingo board`;let t=[...elements.bingoItems].map((e=>e.value.trim())),l=shuffleArraySeed(structuredClone(t),n).map((e=>({value:e,filled:!1})));for(let e=0;e<board.length;e++){const n=l.findIndex((n=>n.value==board[e].value));l[n].filled=board[e].filled,elements.previewCells[e].classList.remove("filled")}for(let e=0;e<elements.previewCells.length;e++)elements.previewCells[e].innerText=l[e].value,elements.previewCells[e].title=l[e].value,l[e].filled&&elements.previewCells[e].classList.add("filled");elements.previewBoard.style.display=""}function hidePreview(){elements.previewBoard.style.display="none"}window.onload=async function(){seenChannels=JSON.parse(localStorage.getItem("seenChannels_bingo"))||[],elements.seenChannels.innerHTML=seenChannels.length,elements.resetSeenChannels.onclick=function(){localStorage.setItem("seenChannels_bingo",JSON.stringify([])),elements.seenChannels.innerHTML=0,seenChannels=[],showToast("Seen channels reset","success",2e3)},loginExpiredModal=new bootstrap.Modal(elements.loginExpiredModal),editModal=new bootstrap.Modal(elements.editModal),copyButton=new bootstrap.Tooltip(elements.copyButton),TWITCH=JSON.parse(localStorage.getItem("TWITCH")),TWITCH?.access_token&&!await checkToken(TWITCH.access_token)&&(TWITCH.channel="",TWITCH.access_token="",loginExpiredModal.show()),TWITCH?.channel&&loadInfo();for(let e=0;e<elements.cells.length;e++)elements.cells[e].onclick=e=>{clearTimeout(refreshCooldown),e.target.classList.toggle("filled");let n=parseInt(e.target.dataset.id,10)-1;board[n].filled=!board[n].filled,checkWin(),TWITCH?.channel&&(refreshCooldown=setTimeout((()=>{refreshLeaderboard()}),3e3))};for(let e=0;e<elements.randomize.length;e++)elements.randomize[e].onclick=e=>{randomize(e)};elements.boardSize.oninput=function(){elements.board.style.scale=this.value},elements.boardOpacity.oninput=function(){elements.board.style.opacity=this.value},elements.board.addEventListener("mousewheel",(e=>{e.preventDefault(),e.stopPropagation();let n=parseFloat(getComputedStyle(elements.board).getPropertyValue("scale"));elements.board.style.scale=e.wheelDelta>0?Math.min(n+.07,2):Math.max(n-.07,.1),elements.boardSize.value=e.wheelDelta>0?n+.07:n-.07})),dragElement(),enableTooltips(),customBadges=await getCustomBadges()};