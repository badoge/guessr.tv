const elements={infoTime:document.getElementById("infoTime"),seenChannels:document.getElementById("seenChannels"),resetSeenChannels:document.getElementById("resetSeenChannels"),toastContainer:document.getElementById("toastContainer"),twitchEmbed:document.getElementById("twitchEmbed"),nextStream:document.getElementById("nextStream"),previousStream:document.getElementById("previousStream"),pfp:document.getElementById("pfp"),username:document.getElementById("username"),title:document.getElementById("title"),tags:document.getElementById("tags")};let player,mainList=[],seenChannels=[],previousChannels=[],retryLimit=0;async function getMainList(){let e={headers:{pragma:"no-cache","cache-control":"no-cache"}};try{let n=await fetch(`https://guessr.donk.workers.dev/list?dank=${Date.now()}`,e),t=await n.json();console.log(t),mainList=t.list,elements.infoTime.innerHTML=`Channel list updated on ${new Date(t.time)}`}catch(e){showToast("Could not load channel list :(","danger","5000"),console.log(e)}}async function nextStream(){let e=player?.getChannel()||0,n=previousChannels.findIndex((n=>n.username==e));if(previousChannels[n+1])return void showPreviousStream(n,!0);elements.pfp.src="/pics/guessr.png",elements.username.innerHTML='<span class="placeholder-wave"><span class="placeholder" style="width: 200px"></span></span>',elements.title.innerHTML='<span class="placeholder-wave"><span class="placeholder" style="width: 500px"></span></span>',elements.tags.innerHTML='<span class="placeholder-wave"><span class="placeholder" style="width: 500px"></span></span>',elements.nextStream.disabled=!0,setTimeout((()=>{elements.nextStream.disabled=!1}),2e3),previousChannels.length>0&&(elements.previousStream.disabled=!1);let t=mainList.pop();for(;seenChannels.includes(t);)t=mainList.pop();if(0!=mainList.length&&t)if(retryLimit>5)showToast("Too many retries, something might be wrong :(","danger","3000");else try{let e=await fetch(`https://helper.guessr.tv/twitch/streams?user_id=${t}`),n=await e.json();if(!n.data[0])return retryLimit++,nextStream();let s=await fetch(`https://helper.guessr.tv/twitch/users?id=${t}`),a=await s.json();elements.pfp.src=a.data[0].profile_image_url||"/pics/guessr.png";let l=n.data[0].user_name.toLowerCase()==n.data[0].user_login.toLowerCase()?n.data[0].user_name:`${n.data[0].user_name} (${n.data[0].user_login})`;elements.username.innerHTML=`<a target="_blank" rel="noopener noreferrer" href="https://twitch.tv/${n.data[0].user_login}">${l}</a>`,elements.title.innerText=n.data[0]?.title||"no title",elements.tags.innerHTML=n.data[0]?.tags.map((e=>`<span class="badge rounded-pill text-bg-secondary">${e}</span>`)).join(" ")||"no tags",retryLimit=0;let r={width:"100%",height:"100%",channel:n.data[0].user_login,layout:"video-with-chat",parent:["guessr.tv","127.0.0.1"]};player?player.setChannel(n.data[0].user_login):player=new Twitch.Embed("twitchEmbed",r),previousChannels.push({username:n.data[0].user_login,displayname:n.data[0].user_name,title:n.data[0].title,tags:elements.tags.innerHTML,pfp:a.data[0].profile_image_url||"/pics/guessr.png"}),seenChannels.push(t),localforage.setItem("seenChannels",JSON.stringify(seenChannels)),elements.seenChannels.innerHTML=seenChannels.length}catch(e){return console.log(e),retryLimit++,nextStream()}else showToast("No more channels left on the list, refresh to get a new list","danger","3000")}function previousStream(){let e=player.getChannel(),n=previousChannels.findIndex((n=>n.username==e));0!=n?showPreviousStream(n,!1):showToast("Can't go further back","danger","3000")}function showPreviousStream(e,n){let t=previousChannels[e+=n?1:-1];elements.pfp.src=t.pfp||"/pics/guessr.png";let s=t.displayname.toLowerCase()==t.username.toLowerCase()?t.displayname:`${t.displayname} (${t.username})`;elements.username.innerHTML=`<a target="_blank" rel="noopener noreferrer" href="https://twitch.tv/${t.username}">${s}</a>`,elements.title.innerText=t.title,elements.tags.innerHTML=t.tags,player.setChannel(t.username)}window.onload=async function(){localforage.config({driver:localforage.INDEXEDDB,name:"guessr.tv/watch",version:1,storeName:"watch",description:"watch"}),seenChannels=JSON.parse(await localforage.getItem("seenChannels"))||[],elements.seenChannels.innerHTML=seenChannels.length,elements.resetSeenChannels.onclick=function(){localforage.setItem("seenChannels",JSON.stringify([])),elements.seenChannels.innerHTML=0,seenChannels=[],showToast("Seen channels reset","success",2e3)},await getMainList(),shuffleArray(mainList),nextStream(),enableTooltips()};