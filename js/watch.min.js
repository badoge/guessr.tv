const elements={seenChannels:document.getElementById("seenChannels"),resetSeenChannels:document.getElementById("resetSeenChannels"),toastContainer:document.getElementById("toastContainer"),twitchEmbed:document.getElementById("twitchEmbed"),nextStream:document.getElementById("nextStream"),previousStream:document.getElementById("previousStream"),pfp:document.getElementById("pfp"),username:document.getElementById("username"),title:document.getElementById("title"),tags:document.getElementById("tags"),selectedLanguages:document.getElementById("selectedLanguages"),searchLanguages:document.getElementById("searchLanguages"),languagesDiv:document.getElementById("languagesDiv"),selectedTags:document.getElementById("selectedTags"),searchTags:document.getElementById("searchTags"),tagsDiv:document.getElementById("tagsDiv"),selectedCategories:document.getElementById("selectedCategories"),searchCategories:document.getElementById("searchCategories"),categoriesDiv:document.getElementById("categoriesDiv"),seenCount:document.getElementById("seenCount"),remainingCount:document.getElementById("remainingCount"),languageFilterCount:document.getElementById("languageFilterCount"),tagFilterCount:document.getElementById("tagFilterCount"),categoryFilterCount:document.getElementById("categoryFilterCount"),enableMinFilter:document.getElementById("enableMinFilter"),enableMaxFilter:document.getElementById("enableMaxFilter"),minFilterSlider:document.getElementById("minFilterSlider"),maxFilterSlider:document.getElementById("maxFilterSlider"),minFilter:document.getElementById("minFilter"),maxFilter:document.getElementById("maxFilter")};let player,mainList=new Map,filteredList=new Map,categoryCounts=new Map,languageCounts=new Map,tagCounts=new Map,seenChannels=[],previousChannels=[],retryLimit=0,seenCount=0,maxViewCount=0;async function getMainList(){let e={headers:{pragma:"no-cache","cache-control":"no-cache"}};try{let t=await fetch(`https://guessr.donk.workers.dev/watch?dank=${Date.now()}`,e),n=await t.json();for(let e=0;e<n.length;e++)n[e][1].viewer_count>maxViewCount&&(maxViewCount=n[e][1].viewer_count),""==n[e][1].game_name&&(n[e][1].game_name="No category");mainList=new Map(n),filteredList=new Map(mainList),elements.maxFilter.placeholder=maxViewCount}catch(e){showToast("Could not load channel list :(","danger","5000"),console.log(e)}}function loadCounts(){languageCounts=new Map,tagCounts=new Map,categoryCounts=new Map,mainList.forEach(((e,t,n)=>{languageCounts.set(e.language,(languageCounts.get(e.language)??0)+1),categoryCounts.set(e.game_name,(categoryCounts.get(e.game_name)??0)+1);for(let t=0;t<e?.tags?.length;t++)tagCounts.set(e.tags[t],(tagCounts.get(e.tags[t])??0)+1)})),languageCounts=new Map([...languageCounts.entries()].sort(((e,t)=>t[1]-e[1]))),tagCounts=new Map([...tagCounts.entries()].sort(((e,t)=>t[1]-e[1]))),categoryCounts=new Map([...categoryCounts.entries()].sort(((e,t)=>t[1]-e[1]))),elements.seenCount.innerHTML="0 streams watched",elements.remainingCount.innerHTML=`${mainList.size.toLocaleString()} streams left`}function loadFilters(){elements.languagesDiv.innerHTML="",elements.tagsDiv.innerHTML="",elements.categoriesDiv.innerHTML="";const e=Array.from(tagCounts.entries()).slice(0,10),t=Array.from(categoryCounts.entries()).slice(0,10);languageCounts.forEach(((e,t,n)=>{elements.languagesDiv.insertAdjacentHTML("beforeend",`\n      <div class="form-check">\n        <input class="form-check-input language-filter" type="checkbox" value="${t}" id="${t}_language_checkbox" onchange="updateLanguages()">\n        <label class="form-check-label" for="${t}_language_checkbox">\n          ${getLanguage(t)} <span class="text-body-secondary">(${e.toLocaleString()})</span>\n        </label>\n      </div>`)}));for(let t=0;t<e.length;t++)elements.tagsDiv.insertAdjacentHTML("beforeend",`\n      <div class="form-check">\n        <input class="form-check-input tag-filter" type="checkbox" value="${e[t][0]}" id="${e[t][0]}_tag_checkbox" onchange="updateTags()">\n        <label class="form-check-label" for="${e[t][0]}_tag_checkbox">\n          ${escapeString(e[t][0])} <span class="text-body-secondary">(${e[t][1].toLocaleString()})</span>\n        </label>\n      </div>`);elements.tagsDiv.insertAdjacentHTML("beforeend",`<br><div class="text-body-secondary">${(tagCounts.size-e.length).toLocaleString()} more tags. Use the search box above to find more</div>`);for(let e=0;e<t.length;e++)elements.categoriesDiv.insertAdjacentHTML("beforeend",`\n      <div class="form-check">\n        <input class="form-check-input category-filter" type="checkbox" value="${t[e][0]}" id="${t[e][0].replace(/\s+/g,"_")}_category_checkbox" onchange="updateCategories()">\n        <label class="form-check-label" for="${t[e][0].replace(/\s+/g,"_")}_category_checkbox">\n          ${"No category"==t[e][0]?'<em class="text-body-secondary">No category</em>':escapeString(t[e][0])} \n          <span class="text-body-secondary">(${t[e][1].toLocaleString()})</span>\n        </label>\n      </div>`);elements.categoriesDiv.insertAdjacentHTML("beforeend",`<br><div class="text-body-secondary">${(categoryCounts.size-t.length).toLocaleString()} more categories. Use the search box above to find more</div>`)}function updateLanguages(){const e=Array.from(document.querySelectorAll(".language-filter:checked")).map((e=>e.value)),t=elements.searchLanguages.value;let n;n=t?Array.from(languageCounts.entries()).filter((([e,n])=>getLanguage(e).toLowerCase().includes(t))):Array.from(languageCounts.entries()),0==e.length?elements.selectedLanguages.innerHTML='<span class="text-body-secondary">None (will show all languages)</span>':elements.selectedLanguages.innerHTML="",elements.languagesDiv.innerHTML="";for(let t=0;t<e.length;t++)elements.selectedLanguages.insertAdjacentHTML("beforeend",`\n      <div class="form-check">\n        <input checked class="form-check-input language-filter" type="checkbox" value="${e[t]}" id="${e[t]}_language_checkbox" onchange="updateLanguages()">\n        <label class="form-check-label" for="${e[t]}_language_checkbox">\n          ${getLanguage(e[t])} <span class="text-body-secondary">(${languageCounts.get(e[t]).toLocaleString()})</span>\n        </label>\n      </div>`);for(let t=0;t<n.length;t++)e.includes(n[t][0])||elements.languagesDiv.insertAdjacentHTML("beforeend",`\n      <div class="form-check">\n        <input class="form-check-input language-filter" type="checkbox" value="${n[t][0]}" id="${n[t][0]}_language_checkbox" onchange="updateLanguages()">\n        <label class="form-check-label" for="${n[t][0]}_language_checkbox">\n          ${getLanguage(n[t][0])} <span class="text-body-secondary">(${n[t][1].toLocaleString()})</span>\n        </label>\n      </div>`);0==n.length&&(elements.languagesDiv.innerHTML='<span class="text-body-secondary">No results</span>'),updateFilteredCount()}function updateTags(){const e=Array.from(document.querySelectorAll(".tag-filter:checked")).map((e=>e.value)),t=elements.searchTags.value;let n;n=t?Array.from(tagCounts.entries()).filter((([e,n])=>e.toLowerCase().includes(t))).slice(0,10):Array.from(tagCounts.entries()).slice(0,10),0==e.length?elements.selectedTags.innerHTML='<span class="text-body-secondary">None (will show all tags)</span>':elements.selectedTags.innerHTML="",elements.tagsDiv.innerHTML="";for(let t=0;t<e.length;t++)elements.selectedTags.insertAdjacentHTML("beforeend",`\n      <div class="form-check">\n        <input checked class="form-check-input tag-filter" type="checkbox" value="${e[t]}" id="${e[t]}_tag_checkbox" onchange="updateTags()">\n        <label class="form-check-label" for="${e[t]}_tag_checkbox">\n          ${e[t]} <span class="text-body-secondary">(${tagCounts.get(e[t]).toLocaleString()})</span>\n        </label>\n      </div>`);for(let t=0;t<n.length;t++)e.includes(n[t][0])||elements.tagsDiv.insertAdjacentHTML("beforeend",`\n      <div class="form-check">\n        <input class="form-check-input tag-filter" type="checkbox" value="${n[t][0]}" id="${n[t][0]}_tag_checkbox" onchange="updateTags()">\n        <label class="form-check-label" for="${n[t][0]}_tag_checkbox">\n          ${n[t][0]} <span class="text-body-secondary">(${n[t][1].toLocaleString()})</span>\n        </label>\n      </div>`);0==n.length&&(elements.tagsDiv.innerHTML='<span class="text-body-secondary">No results</span>'),updateFilteredCount()}function updateCategories(){const e=Array.from(document.querySelectorAll(".category-filter:checked")).map((e=>e.value)),t=elements.searchCategories.value;let n;n=t?Array.from(categoryCounts.entries()).filter((([e,n])=>e.toLowerCase().includes(t))).slice(0,10):Array.from(categoryCounts.entries()).slice(0,10),0==e.length?elements.selectedCategories.innerHTML='<span class="text-body-secondary">None (will show all categories)</span>':elements.selectedCategories.innerHTML="",elements.categoriesDiv.innerHTML="";for(let t=0;t<e.length;t++)elements.selectedCategories.insertAdjacentHTML("beforeend",`\n      <div class="form-check">\n        <input checked class="form-check-input category-filter" type="checkbox" value="${e[t]}" id="${e[t].replace(/\s+/g,"_")}_category_checkbox" onchange="updateCategories()">\n        <label class="form-check-label" for="${e[t].replace(/\s+/g,"_")}_category_checkbox">\n          ${"No category"==e[t]?'<em class="text-body-secondary">No category</em>':escapeString(e[t])} <span class="text-body-secondary">(${categoryCounts.get(e[t]).toLocaleString()})</span>\n        </label>\n      </div>`);for(let t=0;t<n.length;t++)e.includes(n[t][0])||elements.categoriesDiv.insertAdjacentHTML("beforeend",`\n      <div class="form-check">\n        <input class="form-check-input category-filter" type="checkbox" value="${n[t][0]}" id="${n[t][0].replace(/\s+/g,"_")}_category_checkbox" onchange="updateCategories()">\n        <label class="form-check-label" for="${n[t][0].replace(/\s+/g,"_")}_category_checkbox">\n          ${"No category"==n[t][0]?'<em class="text-body-secondary">No category</em>':escapeString(n[t][0])} <span class="text-body-secondary">(${n[t][1].toLocaleString()})</span>\n        </label>\n      </div>`);0==n.length&&(elements.categoriesDiv.innerHTML='<span class="text-body-secondary">No results</span>'),updateFilteredCount()}function updateFilteredCount(){filteredList=new Map(mainList);let e=Array.from(document.querySelectorAll(".language-filter:checked")).map((e=>e.value)),t=Array.from(document.querySelectorAll(".tag-filter:checked")).map((e=>e.value)),n=Array.from(document.querySelectorAll(".category-filter:checked")).map((e=>e.value)),a=parseInt(elements.minFilter.value),s=parseInt(elements.maxFilter.value);for(const[l,r]of filteredList)e.length&&!e.includes(r.language)&&filteredList.delete(l),t.length&&!t.some((e=>r.tags?.includes(e)))&&filteredList.delete(l),n.length&&!n.includes(r.game_name)&&filteredList.delete(l),elements.enableMinFilter.checked&&r.viewer_count<a&&filteredList.delete(l),elements.enableMaxFilter.checked&&r.viewer_count>s&&filteredList.delete(l);elements.languageFilterCount.innerHTML=e.length?` (${e.length})`:"",elements.tagFilterCount.innerHTML=t.length?` (${t.length})`:"",elements.categoryFilterCount.innerHTML=n.length?` (${n.length})`:"",updateCounts()}function updateCounts(){elements.seenCount.innerHTML=`${seenCount} ${1==seenCount?"stream":"streams"} watched`,elements.remainingCount.innerHTML=`${filteredList.size.toLocaleString()} ${1==filteredList.size?"stream":"streams"} left`}async function nextStream(){let e=player?.getChannel()||0,t=previousChannels.findIndex((t=>t.username==e));if(previousChannels[t+1])return void showPreviousStream(t,!0);elements.pfp.src="/pics/guessr.png",elements.username.innerHTML='<span class="placeholder-wave"><span class="placeholder" style="width: 200px"></span></span>',elements.title.innerHTML='<span class="placeholder-wave"><span class="placeholder" style="width: 500px"></span></span>',elements.tags.innerHTML='<span class="placeholder-wave"><span class="placeholder" style="width: 500px"></span></span>',elements.nextStream.disabled=!0,setTimeout((()=>{elements.nextStream.disabled=!1}),2e3),previousChannels.length>0&&(elements.previousStream.disabled=!1);let n=Array.from(filteredList.keys()),a=n[Math.floor(Math.random()*n.length)];for(filteredList.delete(a),updateCounts();seenChannels.includes(a);)a=Math.floor(Math.random()*n.length),filteredList.delete(a),updateCounts();if(0!=filteredList.size&&a)if(retryLimit>5)showToast("Too many retries, something might be wrong :(","danger","3000");else try{let e=await fetch(`https://helper.guessr.tv/twitch/streams?user_id=${a}`),t=await e.json();if(!t.data[0])return retryLimit++,nextStream();let n=await fetch(`https://helper.guessr.tv/twitch/users?id=${a}`),s=await n.json();elements.pfp.src=s.data[0].profile_image_url||"/pics/guessr.png";let l=t.data[0].user_name.toLowerCase()==t.data[0].user_login.toLowerCase()?t.data[0].user_name:`${t.data[0].user_name} (${t.data[0].user_login})`;elements.username.innerHTML=`<a target="_blank" rel="noopener noreferrer" href="https://twitch.tv/${t.data[0].user_login}">${l}</a>`,elements.title.innerText=t.data[0]?.title||"no title",elements.tags.innerHTML=t.data[0]?.tags.map((e=>`<span class="badge rounded-pill text-bg-secondary">${e}</span>`)).join(" ")||"no tags",retryLimit=0;let r={width:"100%",height:"100%",channel:t.data[0].user_login,layout:"video-with-chat",parent:["guessr.tv","127.0.0.1"]};player?player.setChannel(t.data[0].user_login):player=new Twitch.Embed("twitchEmbed",r),previousChannels.push({username:t.data[0].user_login,displayname:t.data[0].user_name,title:t.data[0].title,tags:elements.tags.innerHTML,pfp:s.data[0].profile_image_url||"/pics/guessr.png"}),seenChannels.push(a),localforage.setItem("seenChannels",JSON.stringify(seenChannels)),elements.seenChannels.innerHTML=seenChannels.length,seenCount++,updateCounts()}catch(e){return console.log(e),retryLimit++,nextStream()}else showToast("No more channels left on the list, change your filters or refresh to get a new list","danger","4000")}function previousStream(){let e=player.getChannel(),t=previousChannels.findIndex((t=>t.username==e));0!=t?showPreviousStream(t,!1):showToast("Can't go further back","danger","3000")}function showPreviousStream(e,t){let n=previousChannels[e+=t?1:-1];elements.pfp.src=n.pfp||"/pics/guessr.png";let a=n.displayname.toLowerCase()==n.username.toLowerCase()?n.displayname:`${n.displayname} (${n.username})`;elements.username.innerHTML=`<a target="_blank" rel="noopener noreferrer" href="https://twitch.tv/${n.username}">${a}</a>`,elements.title.innerText=n.title,elements.tags.innerHTML=n.tags,player.setChannel(n.username)}window.onload=async function(){localforage.config({driver:localforage.INDEXEDDB,name:"guessr.tv/watch",version:1,storeName:"watch",description:"watch"}),seenChannels=JSON.parse(await localforage.getItem("seenChannels"))||[],elements.seenChannels.innerHTML=seenChannels.length,elements.resetSeenChannels.onclick=function(){localforage.setItem("seenChannels",JSON.stringify([])),elements.seenChannels.innerHTML=0,seenChannels=[],showToast("Seen channels reset","success",2e3)},await getMainList(),loadCounts(),loadFilters(),nextStream(),elements.enableMaxFilter.addEventListener("change",(e=>{elements.maxFilter.disabled=!e.target.checked,elements.maxFilterSlider.disabled=!e.target.checked})),elements.enableMinFilter.addEventListener("change",(e=>{elements.minFilter.disabled=!e.target.checked,elements.minFilterSlider.disabled=!e.target.checked})),elements.minFilterSlider.oninput=function(){let e=parseInt(this.value,10);elements.minFilter.value=Math.round(Math.exp(Math.log(maxViewCount)/100*e)),0==e&&(elements.minFilter.value=0)},elements.minFilter.oninput=function(){let e=parseInt(this.value,10);elements.minFilterSlider.value=100*Math.log(e)/Math.log(maxViewCount),0==e&&(elements.minFilterSlider.value=0)},elements.maxFilterSlider.oninput=function(){let e=parseInt(this.value,10);elements.maxFilter.value=Math.round(Math.exp(Math.log(maxViewCount)/100*e)),0==e&&(elements.maxFilter.value=0)},elements.maxFilter.oninput=function(){let e=parseInt(this.value,10);elements.maxFilterSlider.value=100*Math.log(e)/Math.log(maxViewCount),0==e&&(elements.maxFilterSlider.value=0)},elements.minFilterSlider.onchange=function(){updateFilteredCount()},elements.minFilter.onchange=function(){updateFilteredCount()},elements.maxFilterSlider.onchange=function(){updateFilteredCount()},elements.maxFilter.onchange=function(){updateFilteredCount()},elements.enableMinFilter.onchange=function(){updateFilteredCount()},elements.enableMaxFilter.onchange=function(){updateFilteredCount()},enableTooltips()};