const elements={leaderboardCount:document.getElementById("leaderboardCount"),leaderboard:document.getElementById("leaderboard"),toastContainer:document.getElementById("toastContainer"),loginExpiredModal:document.getElementById("loginExpiredModal"),loginButton:document.getElementById("loginButton"),loginInfo:document.getElementById("loginInfo"),username:document.getElementById("username"),score:document.getElementById("score"),refresh:document.getElementById("refresh"),loginInfoPFP:document.getElementById("loginInfoPFP"),board:document.getElementById("board"),previewDiv:document.getElementById("previewDiv"),previewBoard:document.getElementById("previewBoard"),previewUsername:document.getElementById("previewUsername"),channel:document.getElementById("channel"),time:document.getElementById("time")};let loginExpiredModal,streamerID,TWITCH={channel:"",access_token:"",userID:""},board=[],allowDiagonals=!1,won=!1,customBadges=[];function login(){return elements.loginInfoPFP.src="https://guessr.tv/pics/donk.png",elements.loginButton.innerHTML=spinner,window.open("https://bingo.guessr.tv/prompt","loginWindow","toolbar=0,status=0,scrollbars=0,width=500px,height=800px"),!1}function resetLoginButton(){elements.loginButton.innerHTML='<span class="twitch-icon"></span> Sign in with Twitch'}function logout(){TWITCH={channel:"",access_token:"",userID:""},localStorage.setItem("TWITCH",JSON.stringify(TWITCH)),elements.loginButton.style.display="",elements.loginInfo.style.display="none",elements.username.innerText="Loading...",elements.score.innerText="Loading...",elements.loginInfoPFP.src="https://guessr.tv/pics/donk.png"}async function loadInfo(){TWITCH=JSON.parse(localStorage.getItem("TWITCH")),elements.loginButton.style.display="none",elements.loginInfo.style.display="",elements.username.innerText=`Playing as ${TWITCH.channel}`,loadPFP()}function loadBoard(){elements.board.innerHTML="",elements.previewBoard.innerHTML="";let e=shuffleArraySeed(structuredClone(board),TWITCH.userID),n=checkWin(e,!0);elements.score.innerText=`Score: ${n.score} ${1==n.score?"point":"points"} ${n.bingos>0?`(${n.bingos} ${1==n.bingos?"BINGO":"BINGOs"})`:""}`;let t=Math.sqrt(e.length),o=0;for(let n=0;n<t;n++){let r="",s="";for(let l=0;l<t;l++){o++;let a="";0==n&&0==l&&(a='style="border-top-left-radius: 6px"'),0==n&&l==t-1&&(a='style="border-top-right-radius: 6px"'),n==t-1&&0==l&&(a='style="border-bottom-left-radius: 6px"'),n==t-1&&l==t-1&&(a='style="border-bottom-right-radius: 6px"'),1==t&&(a='style="border-radius: 6px"'),r+=`\n      <div data-id="${o}" class="col bingo-cell ${e[o-1].filled?"filled":""}" ${a}>\n      ${encodeHTML(e[o-1].value)}\n      </div>`,s+=`\n      <div data-id="${o}" class="col bingo-cell-preview" ${a}>\n      ${encodeHTML(e[o-1].value)}\n      </div>`}elements.board.insertAdjacentHTML("beforeend",`<div class="row m-0">\n      ${r}\n      </div>`),elements.previewBoard.insertAdjacentHTML("beforeend",`<div class="row m-0">\n      ${s}\n      </div>`)}}async function updateLeaderboard(e){for(let n=0;n<e.length;n++)e[n].userid==streamerID?e[n].board=structuredClone(board):e[n].board=shuffleArraySeed(structuredClone(board),e[n].userid),e[n].result=checkWin(e[n].board);e.sort(((e,n)=>e.result.score-n.result.score)),elements.leaderboardCount.innerHTML=e.length,elements.leaderboard.innerHTML="";for(let n=0;n<e.length;n++)elements.leaderboard.insertAdjacentHTML("afterbegin",`<li class="list-group-item ${e[n].userid==TWITCH.userID?"active":""}">\n      ${addBadges(e[n].userid==streamerID?"streamer":[],e[n].userid)} ${e[n].username}: ${e[n].result.score.toLocaleString()} ${1==e[n].result.score?"point":"points"} ${e[n].result.bingos>0?`(${e[n].result.bingos} ${1==e[n].result.bingos?"BINGO":"BINGOs"})`:""}\n      <i class="material-icons notranslate float-end cursor-pointer" \n      onmouseout="hidePreview()" onmouseover="showPreview('${e[n].username}','${e[n].userid}',${e[n].result.score},${e[n].result.bingos})">\n      preview\n      </i>\n      </li>`)}async function refresh(){elements.refresh.innerHTML=spinner,elements.refresh.disabled=!0,elements.leaderboard.innerHTML=spinner,elements.leaderboardCount.innerHTML="Loading...";try{let e=await fetch(`https://bingo.guessr.tv/${elements.channel.innerText}/refresh`),n=await e.json();console.log(n),allowDiagonals=n.data.allowDiagonals??!1,elements.time.innerHTML=`Updated on: ${new Date(n.data.time)}`,streamerID=n.data.userid;for(let e=0;e<n.data.board.length;e++)board[e].value=n.data.board[e].value,board[e].filled=n.data.board[e].filled;loadBoard(),updateLeaderboard(n.users),showToast("Board & leaderboard refreshed","info",3e3),elements.refresh.innerHTML='<i class="material-icons notranslate">refresh</i>',setTimeout((()=>{elements.refresh.disabled=!1}),3e4)}catch(e){showToast("Could not refresh board","danger",3e3),console.log("refresh error",e),elements.refresh.innerHTML='<i class="material-icons notranslate">refresh</i>',setTimeout((()=>{elements.refresh.disabled=!1}),3e4)}}function checkWin(e,n=!1){let t=[],o=[],r=[[],[]],s=Math.sqrt(e.length);for(let n=0;n<s;n++){let o=[];for(let t=0;t<s;t++)o.push(e[t+n*s]);t.push(o)}for(let e=0;e<t.length;e++){let n=[];for(let o=0;o<t[e].length;o++)n.push(t[o][e]);o.push(n)}for(let e=0;e<s;e++)r[0].push(t[e][e]);for(let e=0;e<s;e++)r[1].push(t[e][s-e-1]);let l={bingos:0,score:0},a={0:0,1:0,2:1,3:10,4:50,5:100,6:200,7:300,8:400,9:500,10:1e3};for(let e=0;e<s;e++){let n=t[e],r=o[e],s=n.reduce(((e,n)=>e+n.filled),0),i=r.reduce(((e,n)=>e+n.filled),0);l.score+=a[s],l.score+=a[i],n.every((e=>e.filled))&&l.bingos++,r.every((e=>e.filled))&&l.bingos++}if(allowDiagonals){let e=r[0].reduce(((e,n)=>e+n.filled),0),n=r[1].reduce(((e,n)=>e+n.filled),0);l.score+=a[e],l.score+=a[n],r[0].every((e=>e.filled))&&l.bingos++,r[1].every((e=>e.filled))&&l.bingos++}return l.score+=1e3*l.bingos,n&&l.bingos>0&&!won&&(showConfetti(2),won=!0),n&&0==l.bingos&&(won=!1),l}async function loadPFP(){let e=await get7TVPFP(TWITCH.userID);"/pics/donk.png"==e&&TWITCH.access_token&&(e=await getTwitchPFP(TWITCH.channel,TWITCH.access_token)),elements.loginInfoPFP.src=e}async function join(){let e={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({userid:TWITCH.userID,username:TWITCH.channel,access_token:TWITCH.access_token,channel:elements.channel.innerText})};try{let n=await fetch("https://bingo.guessr.tv/join",e),t=await n.json();console.log(t),board=t.data.board,allowDiagonals=t.data.allowDiagonals,showToast(t.message,"info",3e3)}catch(e){showToast("Could not join game","danger",3e3),console.log("join error",e)}}function showPreview(e,n,t,o){elements.previewUsername.innerHTML=`\n  ${encodeHTML(e)}'s bingo board<br>Score: ${t.toLocaleString()} ${1==t?"point":"points"} ${o>0?`(${o} ${1==o?"BINGO":"BINGOs"})`:""}`;let r=[];r=n==streamerID?structuredClone(board):shuffleArraySeed(structuredClone(board),n);const s=document.querySelectorAll(".bingo-cell-preview");for(let e=0;e<board.length;e++)s[e].classList.remove("filled");for(let e=0;e<s.length;e++)s[e].innerText=r[e].value,s[e].title=r[e].value,r[e].filled&&s[e].classList.add("filled");elements.previewDiv.style.display=""}function hidePreview(){elements.previewDiv.style.display="none"}window.onload=async function(){loginExpiredModal=new bootstrap.Modal(elements.loginExpiredModal),TWITCH=JSON.parse(localStorage.getItem("TWITCH")),TWITCH?.access_token&&!await checkToken(TWITCH.access_token)&&(TWITCH.channel="",TWITCH.access_token="",loginExpiredModal.show()),TWITCH?.channel&&(loadInfo(),await join(),loadBoard(),elements.board.classList.remove("blur")),enableTooltips(),customBadges=await getCustomBadges()};