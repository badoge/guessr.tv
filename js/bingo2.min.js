const elements={leaderboardCount:document.getElementById("leaderboardCount"),leaderboard:document.getElementById("leaderboard"),toastContainer:document.getElementById("toastContainer"),loginExpiredModal:document.getElementById("loginExpiredModal"),loginButton:document.getElementById("loginButton"),loginInfo:document.getElementById("loginInfo"),username:document.getElementById("username"),score:document.getElementById("score"),refresh:document.getElementById("refresh"),loginInfoPFP:document.getElementById("loginInfoPFP"),cells:document.querySelectorAll(".bingo-cell"),board:document.getElementById("board"),previewBoard:document.getElementById("previewBoard"),previewUsername:document.getElementById("previewUsername"),previewCells:document.querySelectorAll(".bingo-cell-preview"),channel:document.getElementById("channel"),time:document.getElementById("time")};let loginExpiredModal,streamerID,TWITCH={channel:"",access_token:"",userID:""},board=[{filled:!1,value:"1"},{filled:!1,value:"2"},{filled:!1,value:"3"},{filled:!1,value:"4"},{filled:!1,value:"5"},{filled:!1,value:"6"},{filled:!1,value:"7"},{filled:!1,value:"8"},{filled:!1,value:"9"},{filled:!1,value:"10"},{filled:!1,value:"11"},{filled:!1,value:"12"},{filled:!1,value:"13"},{filled:!1,value:"14"},{filled:!1,value:"15"},{filled:!1,value:"16"},{filled:!1,value:"17"},{filled:!1,value:"18"},{filled:!1,value:"19"},{filled:!1,value:"20"},{filled:!1,value:"21"},{filled:!1,value:"22"},{filled:!1,value:"23"},{filled:!1,value:"24"},{filled:!1,value:"25"}],won=!1,allowDiagonals=!1,customBadges=[];function login(){return elements.loginInfoPFP.src="https://guessr.tv/pics/donk.png",elements.loginButton.innerHTML=spinner,window.open("https://bingo.guessr.tv/prompt","loginWindow","toolbar=0,status=0,scrollbars=0,width=500px,height=800px"),!1}function resetLoginButton(){elements.loginButton.innerHTML='<span class="twitch-icon"></span> Sign in with Twitch'}function logout(){TWITCH={channel:"",access_token:"",userID:""},localStorage.setItem("TWITCH",JSON.stringify(TWITCH)),elements.loginButton.style.display="",elements.loginInfo.style.display="none",elements.username.innerText="Loading...",elements.score.innerText="Loading...",elements.loginInfoPFP.src="https://guessr.tv/pics/donk.png"}async function loadInfo(){TWITCH=JSON.parse(localStorage.getItem("TWITCH")),elements.loginButton.style.display="none",elements.loginInfo.style.display="",elements.username.innerText=`Playing as ${TWITCH.channel}`,loadPFP()}function loadBoard(){let e=shuffleArraySeed(structuredClone(board),TWITCH.userID);for(let l=0;l<e.length;l++)elements.cells[l].innerText=e[l].value,e[l].filled?elements.cells[l].classList.add("filled"):elements.cells[l].classList.remove("filled");let l=checkWin(e,!0);elements.score.innerText=`Score: ${l.score} ${1==l.score?"point":"points"} ${l.five>0?`(${l.five} ${1==l.five?"BINGO":"BINGOs"})`:""}`}async function updateLeaderboard(e){for(let l=0;l<e.length;l++)e[l].userid==streamerID?e[l].board=structuredClone(board):e[l].board=shuffleArraySeed(structuredClone(board),e[l].userid),e[l].result=checkWin(e[l].board);e.sort(((e,l)=>e.result.score-l.result.score)),elements.leaderboardCount.innerHTML=e.length,elements.leaderboard.innerHTML="";for(let l=0;l<e.length;l++)elements.leaderboard.insertAdjacentHTML("afterbegin",`<li class="list-group-item ${e[l].userid==TWITCH.userID?"active":""}">\n      ${addBadges(e[l].userid==streamerID?"streamer":[],e[l].userid)} ${e[l].username}:\n       ${e[l].result.score} ${1==e[l].result.score?"point":"points"} \n       ${e[l].result.five>0?`(${e[l].result.five} ${1==e[l].result.five?"BINGO":"BINGOs"})`:""}\n       <i class="material-icons notranslate float-end cursor-pointer" onmouseout="hidePreview()" onmouseover="showPreview('${e[l].username}','${e[l].userid}')">preview</i>\n       </li>`)}async function refresh(){elements.refresh.innerHTML=spinner,elements.refresh.disabled=!0,elements.leaderboard.innerHTML=spinner,elements.leaderboardCount.innerHTML="Loading...";let e={method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},redirect:"follow"};try{let l=await fetch(`https://bingo.guessr.tv/${elements.channel.innerText}/refresh`,e),n=await l.json();console.log(n),allowDiagonals=n.data.allowDiagonals??!1,elements.time.innerHTML=`Updated on: ${new Date(n.data.time)}`,streamerID=n.data.userid;for(let e=0;e<n.data.board.length;e++)board[e].value=n.data.board[e].value,board[e].filled=n.data.board[e].filled;loadBoard(),updateLeaderboard(n.users),showToast("Board & leaderboard refreshed","info",3e3),elements.refresh.innerHTML='<i class="material-icons notranslate">refresh</i>',setTimeout((()=>{elements.refresh.disabled=!1}),3e4)}catch(e){showToast("Could not refresh board","danger",3e3),console.log("refresh error",e),elements.refresh.innerHTML='<i class="material-icons notranslate">refresh</i>',setTimeout((()=>{elements.refresh.disabled=!1}),3e4)}}function checkWin(e,l=!1){let n=[[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24]],t=[[0,1,2,3],[1,2,3,4],[5,6,7,8],[6,7,8,9],[10,11,12,13],[11,12,13,14],[15,16,17,18],[16,17,18,19],[20,21,22,23],[21,22,23,24],[0,5,10,15],[5,10,15,20],[1,6,11,16],[6,11,16,21],[2,7,12,17],[7,12,17,22],[3,8,13,18],[8,13,18,23],[4,9,14,19],[9,14,19,24],[0,2,3,4],[0,1,3,4],[0,1,2,4],[5,7,8,9],[5,6,8,9],[5,6,7,9],[10,12,13,14],[10,11,13,14],[10,11,12,14],[15,17,18,19],[15,16,18,19],[15,16,17,19],[20,22,23,24],[20,21,23,24],[20,21,22,24],[0,10,15,20],[0,5,15,20],[0,5,10,20],[1,11,16,21],[1,6,16,21],[1,6,11,21],[2,12,17,22],[2,7,17,22],[2,7,12,22],[3,13,18,23],[3,8,18,23],[3,8,13,23],[4,14,19,24],[4,9,19,24],[4,9,14,24]],o=[[0,1,2],[1,2,3],[2,3,4],[5,6,7],[6,7,8],[7,8,9],[10,11,12],[11,12,13],[12,13,14],[15,16,17],[16,17,18],[17,18,19],[20,21,22],[21,22,23],[22,23,24],[0,5,10],[5,10,15],[10,15,20],[1,6,11],[6,11,16],[11,16,21],[2,7,12],[7,12,17],[12,17,22],[3,8,13],[8,13,18],[13,18,23],[4,9,14],[9,14,19],[14,19,24]];allowDiagonals&&(n.push([0,6,12,18,24],[4,8,12,16,20]),t.push([0,6,12,18],[4,8,12,16],[6,12,18,24],[8,12,16,20],[0,12,18,24],[0,6,18,24],[0,6,12,24],[4,12,16,20],[4,8,16,20],[4,8,12,20]),o.push([0,6,12],[6,12,18],[12,18,24],[4,8,12],[8,12,16],[12,16,20]));let s={five:0,four:0,three:0,score:0};for(let l=0;l<n.length;l++)e[n[l][0]].filled&&e[n[l][1]].filled&&e[n[l][2]].filled&&e[n[l][3]].filled&&e[n[l][4]].filled&&s.five++;for(let l=0;l<t.length;l++)e[t[l][0]].filled&&e[t[l][1]].filled&&e[t[l][2]].filled&&e[t[l][3]].filled&&s.four++;for(let l=0;l<o.length;l++)e[o[l][0]].filled&&e[o[l][1]].filled&&e[o[l][2]].filled&&s.three++;return s.score=s.three+10*s.four+110*s.five,l&&s.five>0&&!won&&(showConfetti(2),won=!0),l&&0==s.five&&(won=!1),s}async function loadPFP(){let e=await get7TVPFP(TWITCH.userID);"/pics/donk.png"==e&&TWITCH.access_token&&(e=await getTwitchPFP(TWITCH.channel,TWITCH.access_token)),elements.loginInfoPFP.src=e}async function join(){let e={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({userid:TWITCH.userID,username:TWITCH.channel,access_token:TWITCH.access_token,channel:elements.channel.innerText}),redirect:"follow"};try{let l=await fetch("https://bingo.guessr.tv/join",e),n=await l.json();showToast(n.message,"info",3e3)}catch(e){showToast("Could not join game","danger",3e3),console.log("join error",e)}}function showPreview(e,l){elements.previewUsername.innerText=`${e}'s bingo board`;let n=[];n=l==streamerID?structuredClone(board):shuffleArraySeed(structuredClone(board),l);for(let e=0;e<board.length;e++)elements.previewCells[e].classList.remove("filled");for(let e=0;e<elements.previewCells.length;e++)elements.previewCells[e].innerText=n[e].value,elements.previewCells[e].title=n[e].value,n[e].filled&&elements.previewCells[e].classList.add("filled");elements.previewBoard.style.display=""}function hidePreview(){elements.previewBoard.style.display="none"}window.onload=async function(){loginExpiredModal=new bootstrap.Modal(elements.loginExpiredModal),TWITCH=JSON.parse(localStorage.getItem("TWITCH")),TWITCH?.access_token&&!await checkToken(TWITCH.access_token)&&(TWITCH.channel="",TWITCH.access_token="",loginExpiredModal.show()),TWITCH?.channel&&(loadInfo(),await join(),elements.board.classList.remove("blur"),board=[...elements.cells].map((e=>({value:e.innerText,filled:e.classList.contains("filled")}))),loadBoard()),enableTooltips(),customBadges=await getCustomBadges()};