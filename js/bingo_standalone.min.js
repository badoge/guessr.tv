const elements={leaderboardCount:document.getElementById("leaderboardCount"),leaderboard:document.getElementById("leaderboard"),loginExpiredModal:document.getElementById("loginExpiredModal"),editModal:document.getElementById("editModal"),allowDiagonals:document.getElementById("allowDiagonals"),bingoItems:document.querySelectorAll(".bingo-item"),randomize:document.querySelectorAll(".bingo-random"),bingoSave:document.getElementById("bingoSave"),board:document.getElementById("board"),previewBoard:document.getElementById("previewBoard"),previewUsername:document.getElementById("previewUsername"),cells:document.querySelectorAll(".bingo-cell"),previewCells:document.querySelectorAll(".bingo-cell-preview"),toastContainer:document.getElementById("toastContainer"),welcomeCard:document.getElementById("welcomeCard"),start:document.getElementById("start"),mainCard:document.getElementById("mainCard"),boardSize:document.getElementById("boardSize"),boardOpacity:document.getElementById("boardOpacity"),loginButton:document.getElementById("loginButton"),loginInfo:document.getElementById("loginInfo"),loginInfoPFP:document.getElementById("loginInfoPFP"),bingoLink:document.getElementById("bingoLink"),copyButton:document.getElementById("copyButton"),previousStream:document.getElementById("previousStream"),bingoPopover:document.getElementById("bingoPopover")};let loginExpiredModal,editModal,copyButton,refreshCooldown,channelName,bingoPopover,TWITCH={channel:"",access_token:"",userID:""},customBadges=[],board=[{filled:!1,value:"1"},{filled:!1,value:"2"},{filled:!1,value:"3"},{filled:!1,value:"4"},{filled:!1,value:"5"},{filled:!1,value:"6"},{filled:!1,value:"7"},{filled:!1,value:"8"},{filled:!1,value:"9"},{filled:!1,value:"10"},{filled:!1,value:"11"},{filled:!1,value:"12"},{filled:!1,value:"13"},{filled:!1,value:"14"},{filled:!1,value:"15"},{filled:!1,value:"16"},{filled:!1,value:"17"},{filled:!1,value:"18"},{filled:!1,value:"19"},{filled:!1,value:"20"},{filled:!1,value:"21"},{filled:!1,value:"22"},{filled:!1,value:"23"},{filled:!1,value:"24"},{filled:!1,value:"25"}],won=!1,boardCreated=!1;function randomize(e){const t=e.target.dataset.itemId,l=document.querySelector(`[data-item-id="${t}"]`),n=[...elements.bingoItems].map((e=>e.value));let o=suggestions[Math.floor(Math.random()*suggestions.length)];for(;n.includes(o);)o=suggestions[Math.floor(Math.random()*suggestions.length)];l.value=o}function randomizeAll(){let e=shuffleArray(structuredClone(suggestions));for(let t=0;t<elements.bingoItems.length;t++)elements.bingoItems[t].value=e.pop()}function clearAll(){for(let e=0;e<elements.bingoItems.length;e++)elements.bingoItems[e].value=""}async function start(){if(!boardCreated)return showToast("You need to create and save your board first","warning",3e3),void editModal.show();elements.start.innerHTML=spinner,elements.welcomeCard.style.display="none",elements.board.style.display="",elements.mainCard.style.display=""}async function bingoSave(){elements.bingoSave.innerHTML=spinner;let e=[];if(e=TWITCH?.userID?shuffleArraySeed([...elements.bingoItems].map((e=>e.value.trim())),TWITCH.userID):shuffleArray([...elements.bingoItems].map((e=>e.value.trim()))),e.includes(""))return showToast("Board must be full","warning",2e3),void(elements.bingoSave.innerHTML='<i class="material-icons notranslate">save</i> Save');if(hasDuplicates(e))return showToast("Board must not have duplicates","warning",2e3),void(elements.bingoSave.innerHTML='<i class="material-icons notranslate">save</i> Save');for(let t=0;t<elements.cells.length;t++)elements.cells[t].innerText=e[t],elements.cells[t].title=e[t],elements.cells[t].classList.remove("filled"),board[t].value=e[t],board[t].filled=!1;if(won=!1,TWITCH?.access_token){let e={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({userid:TWITCH.userID,username:TWITCH.channel,access_token:TWITCH.access_token,time:new Date,board:board,allowDiagonals:elements.allowDiagonals.checked}),redirect:"follow"};try{let t=await fetch("https://bingo.guessr.tv/save",e),l=await t.json();showToast(l.message,"info",3e3)}catch(e){showToast("Could not upload board","danger",3e3),console.log("save error",e)}}boardCreated=!0,editModal.hide(),elements.bingoSave.innerHTML='<i class="material-icons notranslate">save</i> Save'}function checkWin(e,t=!1){let l=[[0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],[0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24]],n=[[0,1,2,3],[1,2,3,4],[5,6,7,8],[6,7,8,9],[10,11,12,13],[11,12,13,14],[15,16,17,18],[16,17,18,19],[20,21,22,23],[21,22,23,24],[0,5,10,15],[5,10,15,20],[1,6,11,16],[6,11,16,21],[2,7,12,17],[7,12,17,22],[3,8,13,18],[8,13,18,23],[4,9,14,19],[9,14,19,24],[0,2,3,4],[0,1,3,4],[0,1,2,4],[5,7,8,9],[5,6,8,9],[5,6,7,9],[10,12,13,14],[10,11,13,14],[10,11,12,14],[15,17,18,19],[15,16,18,19],[15,16,17,19],[20,22,23,24],[20,21,23,24],[20,21,22,24],[0,10,15,20],[0,5,15,20],[0,5,10,20],[1,11,16,21],[1,6,16,21],[1,6,11,21],[2,12,17,22],[2,7,17,22],[2,7,12,22],[3,13,18,23],[3,8,18,23],[3,8,13,23],[4,14,19,24],[4,9,19,24],[4,9,14,24]],o=[[0,1,2],[1,2,3],[2,3,4],[5,6,7],[6,7,8],[7,8,9],[10,11,12],[11,12,13],[12,13,14],[15,16,17],[16,17,18],[17,18,19],[20,21,22],[21,22,23],[22,23,24],[0,5,10],[5,10,15],[10,15,20],[1,6,11],[6,11,16],[11,16,21],[2,7,12],[7,12,17],[12,17,22],[3,8,13],[8,13,18],[13,18,23],[4,9,14],[9,14,19],[14,19,24]];elements.allowDiagonals.checked&&(l.push([0,6,12,18,24],[4,8,12,16,20]),n.push([0,6,12,18],[4,8,12,16],[6,12,18,24],[8,12,16,20],[0,12,18,24],[0,6,18,24],[0,6,12,24],[4,12,16,20],[4,8,16,20],[4,8,12,20]),o.push([0,6,12],[6,12,18],[12,18,24],[4,8,12],[8,12,16],[12,16,20]));let a={five:0,four:0,three:0,score:0};for(let t=0;t<l.length;t++)e[l[t][0]].filled&&e[l[t][1]].filled&&e[l[t][2]].filled&&e[l[t][3]].filled&&e[l[t][4]].filled&&a.five++;for(let t=0;t<n.length;t++)e[n[t][0]].filled&&e[n[t][1]].filled&&e[n[t][2]].filled&&e[n[t][3]].filled&&a.four++;for(let t=0;t<o.length;t++)e[o[t][0]].filled&&e[o[t][1]].filled&&e[o[t][2]].filled&&a.three++;return a.score=a.three+10*a.four+110*a.five,t&&a.five>0&&!won&&(showConfetti(2),won=!0),t&&0==a.five&&(won=!1),a}function login(){return elements.loginInfoPFP.src="/pics/donk.png",elements.bingoLink.value="Loading...",elements.loginButton.innerHTML=spinner,window.open("/prompt.html","loginWindow","toolbar=0,status=0,scrollbars=0,width=500px,height=800px"),!1}function resetLoginButton(){elements.loginButton.innerHTML='<span class="twitch-icon"></span> Sign in with Twitch'}function logout(){TWITCH={channel:"",access_token:"",userID:""},localStorage.setItem("TWITCH",JSON.stringify(TWITCH)),elements.loginButton.disabled=!1,elements.loginButton.innerHTML='<span class="twitch-icon"></span> Sign in with Twitch',elements.loginInfo.style.display="none",elements.loginInfoPFP.src="/pics/donk.png",elements.bingoLink.value="https://bingo.guessr.tv"}async function loadPFP(){let e=await get7TVPFP(TWITCH.userID);"/pics/donk.png"==e&&TWITCH.access_token&&(e=await getTwitchPFP(TWITCH.channel,TWITCH.access_token)),elements.loginInfoPFP.src=e}function loadInfo(){TWITCH=JSON.parse(localStorage.getItem("TWITCH")),elements.loginButton.disabled=!0,elements.loginButton.innerHTML='<span class="twitch-icon"></span><i class="material-icons notranslate">done</i>Logged in',elements.loginInfo.style.display="",elements.bingoLink.value=`https://bingo.guessr.tv/${TWITCH.channel}`,loadPFP()}function copyLink(){elements.bingoLink.select(),elements.bingoLink.setSelectionRange(0,99999),navigator.clipboard.writeText(elements.bingoLink.value),copyButton.show(),setTimeout((()=>{copyButton.hide()}),1e3)}let chatWinner=!1;async function updateLeaderboard(){elements.leaderboard.innerHTML="",elements.leaderboardCount.innerHTML="";let e={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({userid:TWITCH.userID,username:TWITCH.channel,access_token:TWITCH.access_token,time:new Date,board:board,allowDiagonals:elements.allowDiagonals.checked}),redirect:"follow"};try{let t=await fetch("https://bingo.guessr.tv/update",e),l=await t.json();console.log(l);let n=l.users;for(let e=0;e<n.length;e++)n[e].userid==TWITCH.userID?n[e].board=structuredClone(board):n[e].board=shuffleArraySeed(structuredClone(board),n[e].userid),n[e].result=checkWin(n[e].board);n.sort(((e,t)=>e.result.score-t.result.score)),elements.leaderboardCount.innerHTML=n.length;for(let e=0;e<n.length;e++)!chatWinner&&n[e].result.five>0&&(chatWinner=!0,bingoPopover.show(),setTimeout((()=>{bingoPopover.hide()}),3e3)),elements.leaderboard.insertAdjacentHTML("afterbegin",`<li class="list-group-item">\n        ${addBadges(n[e].userid==TWITCH.userID?"streamer":[],n[e].userid)} ${n[e].username}: ${n[e].result.score} ${1==n[e].result.score?"point":"points"} ${n[e].result.five>0?`(${n[e].result.five} ${1==n[e].result.five?"BINGO":"BINGOs"})`:""}\n        <i class="material-icons notranslate float-end cursor-pointer" onmouseout="hidePreview()" onmouseover="showPreview('${n[e].username}','${n[e].userid}')">preview</i>\n        </li>`)}catch(e){showToast("Could not refresh leaderboard","danger",3e3),console.log("updateLeaderboard error",e)}}function showPreview(e,t){elements.previewUsername.innerText=`${e}'s bingo board`;let l=[];l=t==TWITCH.userID?structuredClone(board):shuffleArraySeed(structuredClone(board),t);for(let e=0;e<board.length;e++)elements.previewCells[e].classList.remove("filled");for(let e=0;e<elements.previewCells.length;e++)elements.previewCells[e].innerText=l[e].value,elements.previewCells[e].title=l[e].value,l[e].filled&&elements.previewCells[e].classList.add("filled");elements.previewBoard.style.display=""}function hidePreview(){elements.previewBoard.style.display="none"}window.onload=async function(){loginExpiredModal=new bootstrap.Modal(elements.loginExpiredModal),editModal=new bootstrap.Modal(elements.editModal),copyButton=new bootstrap.Tooltip(elements.copyButton,{trigger:"hover"}),bingoPopover=new bootstrap.Popover(elements.bingoPopover),TWITCH=JSON.parse(localStorage.getItem("TWITCH")),TWITCH?.access_token&&!await checkToken(TWITCH.access_token)&&(TWITCH.channel="",TWITCH.access_token="",loginExpiredModal.show()),TWITCH?.channel&&(channelName=TWITCH.channel,loadInfo(),sendUsername("/bingo_standalone"));for(let e=0;e<elements.cells.length;e++)elements.cells[e].onclick=e=>{clearTimeout(refreshCooldown),e.target.classList.toggle("filled");let t=parseInt(e.target.dataset.id,10)-1;board[t].filled=!board[t].filled,checkWin(board,!0),TWITCH?.channel&&(refreshCooldown=setTimeout((()=>{updateLeaderboard()}),3e3))};for(let e=0;e<elements.randomize.length;e++)elements.randomize[e].onclick=e=>{randomize(e)};elements.boardSize.oninput=function(){elements.board.style.scale=this.value},elements.boardOpacity.oninput=function(){elements.board.style.opacity=this.value},elements.board.addEventListener("mousewheel",(e=>{if(e.preventDefault(),e.stopPropagation(),e.ctrlKey){let t=parseFloat(getComputedStyle(elements.board).getPropertyValue("opacity"));elements.board.style.opacity=e.wheelDelta>0?Math.min(t+.07,1):Math.max(t-.07,0),elements.boardOpacity.value=e.wheelDelta>0?t+.07:t-.07}else{let t=parseFloat(getComputedStyle(elements.board).getPropertyValue("scale"));elements.board.style.scale=e.wheelDelta>0?Math.min(t+.07,2):Math.max(t-.07,.1),elements.boardSize.value=e.wheelDelta>0?t+.07:t-.07}})),enableTooltips(),customBadges=await getCustomBadges()};